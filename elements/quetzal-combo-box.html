<link rel="import" href="popup-source.html">
<link rel="import" href="quetzal-button.html">

<polymer-element name="quetzal-combo-box" extends="popup-source" attributes="closeOnEnter value">

<template>

<style>
@host {
  :scope {
    display: inline-block;
  }
}

#container {
  position: relative;
}

/* TODO: Use flexbox */
#textBox {
  border: none;
  box-sizing: border-box;
  font: inherit;
  margin-right: 1.5em; /* HACK to avoid overlapping button. Not general enough. */
  outline: none;
  padding: 2px;
  position: relative;
}

#dropdownButton {
  bottom: 0;
  height: 100%;
  outline: none;
  position: absolute;
  right: 0;
  top: 0;
}

/* Generic appearance */
#container { 
  border: 1px solid lightgray;
}

#dropdownButton::x-button::x-button {
  background: none; /* REVIEW: Doesn't work */
  border: none !important;
  border-left: 1px solid transparent !important;
  border-radius: 0 !important;
  padding: 0 0.25em !important; /* Tighter padding that normal */
  text-align: center !important;
}

#container:hover #dropdownButton::x-button::x-button {
  border-left-color: lightgray !important;
}

</style>

<shadow>
  <property name="popup">
    <content select="property[name='popup']"></content>
  </property>
  <div id="container">
    <input id="textBox" type="text" value="{{value}}"/>
    <!--
    REVIEW: Because of hacks in quetzal-toggle-button, tabindex="-1" doesn't
    actually remove element from tab order.
    -->
    <quetzal-toggle-button id="dropdownButton" tabindex="-1" on-click="open">â–¼</quetzal-toggle-button>
  </div>
</shadow>

</template>

<script>
Polymer( "quetzal-combo-box", {

  closeOnEnter: true,

  open: function() {
    if ( !this.opened ) {
      if ( this.generic ) {
        // Make dropdown at least as wide as combo box.
        var width = this.getBoundingClientRect().width;
        this.$.popup.style.minWidth = width + "px";
      }
      this.$.dropdownButton.selected = true;
    }
    this.super();
  },

  openOnFocus: true,

  ready: function() {
    this.super();

    // BUG: The following line doesn't have the intended effect. The focusout
    // handler below still gets the focusout event and, because the
    // activeElement will be the body (if the popup's content is all static),
    // the handler will cancel the popup on a click. Need to find some way to
    // absorb those focusout events in that case.
    this.closeOnInsideClick = false;
    // this.openOnClick = false;

    this.addEventListener( "keydown", function( event ) {
      if ( event.keyCode === 13 /* Enter */ && this.opened ) {
        /* Enter key closes popup. */
        this.close();
      }
    }.bind( this ));

    // Close the popup when the combo box loses focus.
    this.addEventListener( "focusout", function( event ) {
      // We want to close the popup if the focus moves completely outside the
      // combo box; i.e., is not within the input box or the popup.
      // Unfortunately, if the user clicks in the popup, the input will blur
      // before we've had a chance to even register the click. And at the point
      // the blur handler here is invoked, the new activeElement is not yet
      // known, so we can't test that. Instead, set a timeout to defer testing
      // of activeElement until after the normal focusout sequence has completed
      // and focus has been placed in the new element.
      if ( this.opened ) {
        setTimeout( function() {
          // Still open?
          if ( this.opened && !this.contains( document.activeElement )) {
            // this.cancel();
          }
        }.bind( this ), 1 );
      }
    }.bind( this ));

    this.$.popup.addEventListener( "canceled", function() {
      this.$.dropdownButton.selected = false;
    }.bind( this ));
    this.$.popup.addEventListener( "closed", function() {
      // Closing the popup leaves the text selected.
      this.$.textBox.focus();
      this._selectAllText();
      this.$.dropdownButton.selected = false;
    }.bind( this ));
  },

  _selectAllText: function() {
    this.$.textBox.setSelectionRange( 0, this.$.textBox.value.length );
  }

});
</script>

</polymer-element>
